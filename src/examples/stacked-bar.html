<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>RespVis - Stacked Bar Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <style>
      #chart {
        width: 100%;
        height: 50vh;
        min-height: 25rem;
      }

      body {
        background-color: floralwhite;
      }
    </style>
  </head>
  <body>
    <h1>Stacked Bar Chart</h1>
    <div id="chart"></div>
    <script src="../respvis.js"></script>
    <script type="module">
      import withPaddingLayout from './components/with-padding-layout.js';
      import withLeftAxis from './components/axis/with-left-axis.js';
      import withBottomAxis from './components/axis/with-bottom-axis.js';
      import withHighlightTick from './components/axis/with-highlight-tick.js';
      import withHighlightBar from './components/stacked-bars/with-highlight-bar.js';
      import withShowLabel from './components/bar-labels/with-show-label.js';
      import withSwatchLegend from './components/legend/with-swatch-legend.js';
      import withHighlightLegendSwatch from './components/legend/with-highlight-swatch.js';
      import withDisableLegendSwatch from './components/legend/with-disable-swatch.js';
      import data from './data/desktop-mobile-tablet.js';

      // data
      const subcategories = ['Desktop', 'Mobile', 'Tablet'],
        values = data.desktop.map((d, i) => [data.desktop[i], data.mobile[i], data.tablet[i]]),
        maxValue = 100;

      // formatters
      var valueFormatter = (value) => `${value}%`;

      const wideMediaQuery = 'screen and (min-width: 40rem)';

      // scales
      const yearScale = respVis.bandScale();
      const shareScale = respVis.linearScale();

      // bars
      const barColors = respVis.StackedBarsComponent.defaultColors;
      const bars = withHighlightBar(respVis.stackedBars()).config({
        categories: data.years,
        categoryScale: { scale: yearScale, padding: 0.1 },
        values: values,
        valueScale: { scale: shareScale, domain: [0, maxValue] },
        orientation: respVis.BarOrientation.Horizontal,
        transitionDuration: 250,
        events: {
          mouseover: (e, d) => hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, true),
          mouseout: (e, d) => hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, false),
        },
        responsiveConfigs: {
          [wideMediaQuery]: {
            orientation: respVis.BarOrientation.Vertical,
            events: {
              mouseover: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, true),
              mouseout: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, false),
            },
          },
        },
      });

      // bar labels
      const barLabels = withShowLabel(respVis.barLabels()).config({
        attributes: { 'pointer-events': 'none', text: { fill: '#fff' } },
        bars: bars,
        labels: values.flat(),
        horizontalPosition: respVis.HorizontalPosition.Center,
        verticalPosition: respVis.VerticalPosition.Center,
        transitionDuration: 250,
      });

      // legend
      const legend = withDisableLegendSwatch(
        withHighlightLegendSwatch(withSwatchLegend(respVis.group()))
      ).config({
        labels: subcategories,
        colors: respVis.GroupedBarsComponent.defaultColors,
        rowCount: 1,
        columnCount: subcategories.length,
        attributes: { cursor: 'default' },
        events: {
          mouseover: (e, d) => hoverLegendSwatch(d.childIndex, true),
          mouseout: (e, d) => hoverLegendSwatch(d.childIndex, false),
        },
        responsiveConfigs: { [wideMediaQuery]: { rowCount: subcategories.length, columnCount: 1 } },
      });

      // bottom axis
      const xAxis = withHighlightTick(withBottomAxis(respVis.group()))
        .call((axis) =>
          axis.ticks.config({
            attributes: { cursor: 'auto' },
            scale: shareScale,
            tickValues: [0, maxValue / 2, maxValue],
            labelFormatter: valueFormatter,
            responsiveConfigs: {
              [wideMediaQuery]: {
                scale: yearScale,
                tickValues: undefined,
                labelFormatter: (value) => value.toString(),
                attributes: { cursor: 'default' },
                events: {
                  mouseover: (e, d) => hoverCategoryAxisTick(xAxis, yAxis, d.tickIndex, true),
                  mouseout: (e, d) => hoverCategoryAxisTick(xAxis, yAxis, d.tickIndex, false),
                },
              },
            },
          })
        )
        .call((axis) =>
          axis.title.config({
            text: 'Market Shares',
            responsiveConfigs: { [wideMediaQuery]: { text: 'Years' } },
          })
        );

      // left axis
      const yAxis = withHighlightTick(withLeftAxis(respVis.group()))
        .call((axis) =>
          axis.ticks.config({
            attributes: { cursor: 'default' },
            scale: yearScale,
            events: {
              mouseover: (e, d) => hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, true),
              mouseout: (e, d) => hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, false),
            },
            responsiveConfigs: {
              [wideMediaQuery]: {
                scale: shareScale,
                labelFormatter: valueFormatter,
                events: {
                  // unregister events
                  mouseover: undefined,
                  mouseout: undefined,
                },
                attributes: { cursor: 'auto' },
              },
            },
          })
        )
        .call((axis) =>
          axis.title.config({
            text: 'Years',
            responsiveConfigs: { [wideMediaQuery]: { text: 'Market Shares' } },
          })
        );

      // chart
      const chart = respVis
        .chart()
        .root(
          withPaddingLayout(respVis.group()).config({
            all: 10,
            children: [
              withPaddingLayout(respVis.group()).config({
                all: 10,
                children: [
                  respVis.group().config({
                    attributes: { 'grid-template': 'auto 1fr / 1fr ' },
                    responsiveConfigs: {
                      [wideMediaQuery]: { attributes: { 'grid-template': '1fr / 1fr auto' } },
                    },
                    children: [
                      withPaddingLayout(respVis.group()).config({
                        top: 5,
                        attributes: { 'grid-area': '2 / 1 / 3 / 2' },
                        responsiveConfigs: {
                          [wideMediaQuery]: {
                            top: 0,
                            right: 5,
                            attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                          },
                        },
                        children: [
                          respVis.group().config({
                            attributes: {
                              'grid-template': '1fr auto / auto 1fr',
                            },
                            children: [
                              // bars
                              bars.config({ attributes: { 'grid-area': '1 / 2 / 2 / 3' } }),

                              // bar labels
                              barLabels.config({ attributes: { 'grid-area': '1 / 2 / 2 / 3' } }),

                              // left axis
                              yAxis.config({ attributes: { 'grid-area': '1 / 1 / 2 / 2' } }),

                              // bottom axis
                              xAxis.config({ attributes: { 'grid-area': '2 / 2 / 3 / 3' } }),
                            ],
                          }),
                        ],
                      }),
                      withPaddingLayout(respVis.group()).config({
                        all: '0.5fr',
                        attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                        responsiveConfigs: {
                          [wideMediaQuery]: { attributes: { 'grid-area': '1 / 2 / 2 / 3' } },
                        },
                        children: [
                          // legend
                          legend,
                        ],
                      }),
                    ],
                  }),
                ],
              }),
            ],
          })
        )
        .mount('#chart');

      function hoverBar(categoryIndex, barIndex, categoryAxis, valueAxis, hover) {
        const flatBarIndex = categoryIndex * subcategories.length + barIndex;
        bars.highlightBar(categoryIndex, barIndex, hover);
        barLabels.showLabel(flatBarIndex, hover);
        legend.highlightSwatch(barIndex, hover);
        valueAxis.clearHighlights();
        categoryAxis.highlightTick(categoryIndex, hover);
        chart.update(false, true);
      }

      function hoverLegendSwatch(swatchIndex, hover) {
        legend.highlightSwatch(swatchIndex, hover);
        data.years.forEach((category, categoryIndex) => {
          const flatBarIndex = categoryIndex * subcategories.length + swatchIndex;
          bars.highlightBar(categoryIndex, swatchIndex, hover);
          barLabels.showLabel(flatBarIndex, hover);
        });
        chart.update(false, true);
      }

      function hoverCategoryAxisTick(categoryAxis, valueAxis, tickIndex, hover) {
        valueAxis.clearHighlights();
        categoryAxis.highlightTick(tickIndex, hover);
        for (let i = 0; i < subcategories.length; ++i) {
          const flatBarIndex = tickIndex * subcategories.length + i;
          bars.highlightBar(tickIndex, i, hover);
          barLabels.showLabel(flatBarIndex, hover);
        }
        chart.update(false, true);
      }
    </script>
  </body>
</html>
