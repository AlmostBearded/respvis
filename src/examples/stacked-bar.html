<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>RespVis - Stacked Bar Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      #chart {
        width: 100%;
        height: 50vh;
        min-height: 25rem;
      }

      body {
        background-color: floralwhite;
      }
    </style>
  </head>
  <body>
    <h1>Stacked Bar Chart</h1>
    <div id="chart"></div>
    <script src="../respvis.js"></script>
    <script src="./components/axis.js"></script>
    <script src="./components/padding.js"></script>
    <script src="./components/matrix.js"></script>
    <script src="./components/swatch-legend.js"></script>
    <script>
      var categories = ['Ken', 'Barbie', 'Hank', 'Fred', 'Susie'];
      var expenses = ['Rent', 'Food', 'Utilities', 'Fun'];
      var values = [
        [600, 150, 50, 20],
        [500, 125, 80, 50],
        [700, 200, 25, 25],
        [550, 175, 75, 100],
        [650, 160, 60, 30],
      ];

      const colors = respVis.StackedBarsComponent.defaultColors;
      const brighten = (color) => respVis.chroma.hex(color).brighten(0.5).hex();

      var bars, barLabels, legend, xAxis, yAxis;

      const wideMediaQuery = 'screen and (min-width: 40rem)';

      function highlightBar(categoryIndex, barIndex, highlight) {
        bars
          .selection()
          .select(`.bar-stack:nth-of-type(${categoryIndex + 1}) .bar:nth-of-type(${barIndex + 1})`)
          .attr('highlighted', highlight);
        bars.config({});
      }

      function highlightBarLabel(labelIndex, highlight) {
        barLabels
          .selection()
          .select(`.label:nth-of-type(${labelIndex + 1})`)
          .attr('highlighted', highlight);
        barLabels.config({});
      }

      function highlightLegendSwatch(swatchIndex, highlight) {
        legend.activeConfig().children[swatchIndex].config({
          rect: {
            attributes: { fill: highlight ? brighten(colors[swatchIndex]) : colors[swatchIndex] },
          },
          label: { attributes: { 'font-weight': highlight ? 'bold' : 'normal' } },
        });
      }

      function highlightAxisTick(axis, tickIndex, highlight) {
        axis
          .selection()
          .select(`.tick:nth-of-type(${tickIndex + 1})`)
          .attr('highlighted', highlight);
        axis.config({});
      }

      function clearAxisHighlights(axis) {
        axis.selection().selectAll('[highlighted]').attr('highlighted', null);
        axis.config({});
      }

      function hoverBar(categoryIndex, barIndex, categoryAxis, valueAxis, hover) {
        const flatBarIndex = categoryIndex * expenses.length + barIndex;
        highlightBar(categoryIndex, barIndex, hover);
        highlightBarLabel(flatBarIndex, hover);
        highlightLegendSwatch(barIndex, hover);
        clearAxisHighlights(valueAxis);
        highlightAxisTick(categoryAxis, categoryIndex, hover);
      }

      function hoverLegendSwatch(swatchIndex, hover) {
        highlightLegendSwatch(swatchIndex, hover);
        categories.forEach((category, categoryIndex) => {
          const flatBarIndex = categoryIndex * expenses.length + swatchIndex;
          highlightBar(categoryIndex, swatchIndex, hover);
          highlightBarLabel(flatBarIndex, hover);
        });
      }

      function hoverCategoryAxisTick(categoryAxis, valueAxis, tickIndex, hover) {
        clearAxisHighlights(valueAxis);
        highlightAxisTick(categoryAxis, tickIndex, hover);
        for (let i = 0; i < expenses.length; ++i) {
          const flatBarIndex = tickIndex * expenses.length + i;
          highlightBar(tickIndex, i, hover);
          highlightBarLabel(flatBarIndex, hover);
        }
      }

      respVis
        .chart()
        .root(
          padding().config({
            all: 10,
            children: [
              padding().config({
                all: 10,
                children: [
                  respVis.group().config({
                    attributes: { 'grid-template': 'auto 1fr / 1fr ' },
                    conditionalConfigs: [
                      {
                        media: wideMediaQuery,
                        config: { attributes: { 'grid-template': '1fr / 1fr auto' } },
                      },
                    ],
                    children: [
                      padding().config({
                        top: 5,
                        attributes: { 'grid-area': '2 / 1 / 3 / 2' },
                        conditionalConfigs: [
                          {
                            media: wideMediaQuery,
                            config: {
                              top: 0,
                              right: 5,
                              attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                            },
                          },
                        ],
                        children: [
                          respVis.group().config({
                            attributes: { 'grid-template': '1fr auto / auto 1fr' },
                            children: [
                              // Bars
                              (bars = respVis.stackedBars().config({
                                attributes: Object.assign(
                                  { 'grid-area': '1 / 2 / 2 / 3' },
                                  ...expenses.map((v, i) => ({
                                    [`.bar:nth-child(${i + 1})[highlighted=true]`]: {
                                      fill: brighten(colors[i]),
                                      'stroke-width': 6,
                                    },
                                  }))
                                ),
                                categories: categories,
                                values: values,
                                orientation: respVis.BarOrientation.Horizontal,
                                transitionDuration: 1000,
                                events: [
                                  {
                                    typenames: 'mouseover',
                                    callback: (e, d) =>
                                      hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, true),
                                  },
                                  {
                                    typenames: 'mouseout',
                                    callback: (e, d) =>
                                      hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, false),
                                  },
                                ],
                                conditionalConfigs: [
                                  {
                                    media: wideMediaQuery,
                                    config: {
                                      orientation: respVis.BarOrientation.Vertical,
                                      events: [
                                        {
                                          typenames: 'mouseover',
                                          callback: (e, d) =>
                                            hoverBar(
                                              d.categoryIndex,
                                              d.barIndex,
                                              xAxis,
                                              yAxis,
                                              true
                                            ),
                                        },
                                        {
                                          typenames: 'mouseout',
                                          callback: (e, d) =>
                                            hoverBar(
                                              d.categoryIndex,
                                              d.barIndex,
                                              xAxis,
                                              yAxis,
                                              false
                                            ),
                                        },
                                      ],
                                    },
                                  },
                                ],
                              })),
                              (barLabels = respVis.barLabels().config({
                                attributes: {
                                  'grid-area': '1 / 2 / 2 / 3',
                                  'pointer-events': 'none',
                                  '.label': { opacity: 0 },
                                  '.label[highlighted=true]': { opacity: 1 },
                                  text: {
                                    'font-weight': 'bold',
                                    'stroke-width': 0.1,
                                    stroke: '#ffffff',
                                  },
                                },
                                bars: bars,
                                labels: values.flat(),
                                horizontalPosition: respVis.HorizontalPosition.Center,
                                verticalPosition: respVis.VerticalPosition.Center,
                                transitionDuration: 1000,
                              })),
                              // Left axis
                              (yAxis = leftAxis().config({
                                attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                                ticks: {
                                  attributes: {
                                    cursor: 'default',
                                    '.tick': { 'font-weight': 'normal' },
                                    '.tick[highlighted=true]': { 'font-weight': 'bold' },
                                  },
                                  scale: bars.categoriesScale(),
                                  events: [
                                    {
                                      typenames: 'mouseover',
                                      callback: (e, d) =>
                                        hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, true),
                                    },
                                    {
                                      typenames: 'mouseout',
                                      callback: (e, d) =>
                                        hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, false),
                                    },
                                  ],
                                  conditionalConfigs: [
                                    {
                                      media: wideMediaQuery,
                                      config: {
                                        scale: bars.valuesScale(),
                                        events: [],
                                        attributes: { cursor: 'auto' },
                                      },
                                    },
                                  ],
                                },
                                title: {
                                  text: 'People',
                                  conditionalConfigs: [
                                    { media: wideMediaQuery, config: { text: 'Expenses' } },
                                  ],
                                },
                              })),
                              // Bottom axis
                              (xAxis = bottomAxis().config({
                                attributes: { 'grid-area': '2 / 2 / 3 / 3' },
                                ticks: {
                                  attributes: {
                                    cursor: 'auto',
                                    '.tick': { 'font-weight': 'normal' },
                                    '.tick[highlighted=true]': { 'font-weight': 'bold' },
                                  },
                                  scale: bars.valuesScale(),
                                  conditionalConfigs: [
                                    {
                                      media: wideMediaQuery,
                                      config: {
                                        scale: bars.categoriesScale(),
                                        attributes: { cursor: 'default' },
                                        events: [
                                          {
                                            typenames: 'mouseover',
                                            callback: (e, d) =>
                                              hoverCategoryAxisTick(
                                                xAxis,
                                                yAxis,
                                                d.tickIndex,
                                                true
                                              ),
                                          },
                                          {
                                            typenames: 'mouseout',
                                            callback: (e, d) =>
                                              hoverCategoryAxisTick(
                                                xAxis,
                                                yAxis,
                                                d.tickIndex,
                                                false
                                              ),
                                          },
                                        ],
                                      },
                                    },
                                  ],
                                },
                                title: {
                                  text: 'Expenses',
                                  conditionalConfigs: [
                                    { media: wideMediaQuery, config: { text: 'People' } },
                                  ],
                                },
                              })),
                            ],
                          }),
                        ],
                      }),
                      (legend = swatchLegend().config({
                        labels: expenses,
                        colors: respVis.GroupedBarsComponent.defaultColors,
                        rowCount: 1,
                        columnCount: expenses.length,
                        attributes: { 'grid-area': '1 / 1 / 2 / 2', cursor: 'default' },
                        events: [
                          {
                            typenames: 'mouseover',
                            callback: (e, d) => hoverLegendSwatch(d.childIndex, true),
                          },
                          {
                            typenames: 'mouseout',
                            callback: (e, d) => hoverLegendSwatch(d.childIndex, false),
                          },
                        ],
                        conditionalConfigs: [
                          {
                            media: wideMediaQuery,
                            config: {
                              rowCount: expenses.length,
                              columnCount: 1,
                              attributes: { 'grid-area': '1 / 2 / 2 / 3' },
                            },
                          },
                        ],
                      })),
                    ],
                  }),
                ],
              }),
            ],
          })
        )
        .mount('#chart');
    </script>
  </body>
</html>
