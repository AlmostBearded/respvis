<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>RespVis - Scatterplot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <style>
      #chart {
        width: 100%;
        height: 50vh;
        min-height: 25rem;
      }

      body {
        background-color: floralwhite;
      }
    </style>
  </head>
  <body>
    <h1>Scatterplot</h1>
    <div id="chart"></div>
    <script src="./d3/d3.v6.js"></script>
    <script src="../respvis.js"></script>
    <script type="module">
      import data from './data/houses.js';

      const areas = data.area,
        prices = data.price.map((price) => price / 1000),
        minArea = Math.min(...areas),
        maxArea = Math.max(...areas),
        areaSpan = maxArea - minArea,
        areaDomain = [0, maxArea + areaSpan * 0.2],
        minPrice = Math.min(...prices),
        maxPrice = Math.max(...prices),
        priceSpan = maxPrice - minPrice,
        priceDomain = [0, maxPrice + priceSpan * 0.2],
        radiuses = prices.map((_) => 1);

      const areaFormatter = (area) => `${area}ftÂ²`;
      const priceFormatter = (price) => `$${price}k`;

      const wideMediaQuery = 'screen and (min-width: 40rem)';

      // scales
      let areaScale = respVis.linearScale().domain(areaDomain);
      let priceScale = respVis.linearScale().domain(priceDomain);
      const radiusScale = respVis.linearScale().domain([0, 1]).range([5, 5]);

      // chart
      const chart = respVis.chart();

      // points
      const points = respVis
        .points()
        .xValues(areas)
        .xScale(areaScale)
        .yValues(prices)
        .yScale(priceScale)
        .radiuses(radiuses)
        .radiusScale(radiusScale)
        .attr('stroke', '#000000')
        .attr('clip-path', 'url(#drawAreaClipPath)');
      // .on('mouseover', (e, d) => console.log('mouse over point', e, d));

      // draw area clip path
      const drawAreaClipPath = respVis
        .clipPath()
        .attr('id', 'drawAreaClipPath')
        .children([respVis.rect().attr('width', '100%').attr('height', '100%')]);

      // zoom
      const zoom = respVis
        .zoom()
        .scaleExtent([1, 30])
        .on('zoom', (e, d) => handleZoom(d.zoomEvent));

      // y axis
      const yAxis = respVis.leftAxis();
      yAxis
        .ticks()
        .scale(priceScale)
        .onConfigureAxis((axis) => axis.tickFormat(priceFormatter));
      yAxis.title().layout('padding-right', 5).text('Price');

      // x axis
      const xAxis = respVis.bottomAxis();
      xAxis
        .ticks()
        .scale(areaScale)
        .onConfigureAxis((axis) => axis.tickFormat(areaFormatter).ticks(3));
      xAxis.title().layout('padding-top', 5).text('Area');

      // chart
      chart
        .root()
        .layout('grid-template', '1fr auto / auto 1fr')
        .layout('padding', 20)
        .children([
          zoom
            .layout('grid-area', '1 / 2 / 2 / 3')
            .children([respVis.defs().children([drawAreaClipPath]), points]),
          yAxis.layout('grid-area', '1 / 1 / 2 / 2'),
          xAxis.layout('grid-area', '2 / 2 / 3 / 3'),
        ]);

      chart.mount('#chart');

      function handleZoom(zoomEvent) {
        // clear point highlights because mouseout events might not be called during transition.
        // points.clearHighlights();

        respVis.rescaleX(zoomEvent.transform, areaScale, areaDomain);
        respVis.rescaleY(zoomEvent.transform, priceScale, priceDomain);

        chart.render();
      }
    </script>
  </body>
</html>
