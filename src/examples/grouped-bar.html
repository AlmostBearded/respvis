<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>RespVis - Grouped Bar Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      #chart {
        width: 100%;
        height: 50vh;
        min-height: 25rem;
      }

      body {
        background-color: floralwhite;
      }
    </style>
  </head>
  <body>
    <h1>Grouped Bar Chart</h1>
    <div id="chart"></div>
    <script src="../respvis.js"></script>
    <script src="./components/axis.js"></script>
    <script src="./components/matrix.js"></script>
    <script src="./components/swatch-legend.js"></script>
    <script>
      var categories = ['Vienna', 'Rome', 'Paris', 'Berlin', 'Amsterdam'];
      var years = ['2018', '2019', '2020'];
      var values = [
        [23, 27, 29],
        [15, 13, 16],
        [43, 55, 70],
        [30, 24, 28],
        [12, 14, 18],
      ];

      const colors = respVis.GroupedBarsComponent.defaultColors;
      const brighten = (color) => respVis.chroma.hex(color).brighten(0.5).hex();

      function highlightBar(categoryIndex, barIndex, categoryAxis, valueAxis) {
        bars
          .selection()
          .select(`.bar-group:nth-of-type(${categoryIndex + 1}) .bar:nth-of-type(${barIndex + 1})`)
          .attr('highlighted', true);
        bars.config({});

        const flatBarIndex = categoryIndex * years.length + barIndex;

        barLabels
          .selection()
          .select(`.label:nth-of-type(${flatBarIndex + 1})`)
          .attr('highlighted', true);
        barLabels.config({});

        legend.activeConfig().children[barIndex].config({
          rect: { attributes: { fill: brighten(colors[barIndex]) } },
          label: { attributes: { 'font-weight': 'bold' } },
        });

        // Clear highlights of wrong axis in case unhighlight never got called
        valueAxis.selection().selectAll('[highlighted]').attr('highlighted', null);
        valueAxis.config({});

        categoryAxis
          .selection()
          .select(`.tick:nth-of-type(${categoryIndex + 1})`)
          .attr('highlighted', true);
        categoryAxis.config({});
      }

      function unhighlightBar(categoryIndex, barIndex, categoryAxis, valueAxis) {
        bars
          .selection()
          .select(`.bar-group:nth-of-type(${categoryIndex + 1}) .bar:nth-of-type(${barIndex + 1})`)
          .attr('highlighted', null);
        bars.config({});

        const flatBarIndex = categoryIndex * years.length + barIndex;

        barLabels
          .selection()
          .select(`.label:nth-of-type(${flatBarIndex + 1})`)
          .attr('highlighted', null);
        barLabels.config({});

        legend.activeConfig().children[barIndex].config({
          rect: { attributes: { fill: colors[barIndex] } },
          label: { attributes: { 'font-weight': 'normal' } },
        });

        // Clear highlights of wrong axis in case unhighlight never got called
        valueAxis.selection().selectAll('[highlighted]').attr('highlighted', null);
        valueAxis.config({});

        categoryAxis
          .selection()
          .select(`.tick:nth-of-type(${categoryIndex + 1})`)
          .attr('highlighted', null);
        categoryAxis.config({});
      }

      var bars, barLabels, legend, xAxis, yAxis;

      respVis
        .chart()
        .root(
          respVis.group().config({
            attributes: { 'grid-template': '5 auto 20 1fr 10 / 10 auto 20' },
            conditionalConfigs: [
              {
                media: 'screen and (min-width: 40rem)',
                config: {
                  attributes: { 'grid-template': '20 1fr 10 / 10 1fr 10 auto 10' },
                },
              },
            ],
            children: [
              respVis.group().config({
                attributes: {
                  'grid-area': '4 / 2 / 5 / 3',
                  'grid-template': '1fr auto / auto 1fr',
                },
                conditionalConfigs: [
                  {
                    media: 'screen and (min-width: 40rem)',
                    config: { attributes: { 'grid-area': '2 / 2 / 3 / 3' } },
                  },
                ],
                children: [
                  // Bars
                  (bars = respVis.groupedBars().config({
                    attributes: Object.assign(
                      { 'grid-area': '1 / 2 / 2 / 3' },
                      ...years.map((v, i) => ({
                        [`.bar:nth-child(${i + 1})[highlighted]`]: {
                          fill: brighten(colors[i]),
                          'stroke-width': 6,
                        },
                      }))
                    ),
                    categories: categories,
                    values: values,
                    orientation: respVis.BarOrientation.Horizontal,
                    transitionDuration: 1000,
                    events: [
                      {
                        typenames: 'mouseover',
                        callback: (e, d) => highlightBar(d.categoryIndex, d.barIndex, xAxis, yAxis),
                      },
                      {
                        typenames: 'mouseout',
                        callback: (e, d) =>
                          unhighlightBar(d.categoryIndex, d.barIndex, xAxis, yAxis),
                      },
                    ],
                    conditionalConfigs: [
                      {
                        media: 'screen and (min-width: 40rem)',
                        config: { orientation: respVis.BarOrientation.Vertical },
                      },
                    ],
                  })),
                  (barLabels = respVis.barLabels().config({
                    attributes: {
                      'grid-area': '1 / 2 / 2 / 3',
                      '.label': { opacity: 0 },
                      '.label[highlighted]': { opacity: 1 },
                      text: {
                        'dominant-baseline': 'middle',
                        'text-anchor': 'start',
                        transform: 'translate(2, 0)',
                        'font-weight': 'bold',
                      },
                    },
                    bars: bars,
                    labels: values.flat(),
                    horizontalPosition: respVis.HorizontalPosition.Right,
                    verticalPosition: respVis.VerticalPosition.Center,
                    transitionDuration: 1000,
                    conditionalConfigs: [
                      {
                        media: 'screen and (min-width: 40rem)',
                        config: {
                          horizontalPosition: respVis.HorizontalPosition.Center,
                          verticalPosition: respVis.VerticalPosition.Top,
                          attributes: {
                            text: {
                              'dominant-baseline': 'auto',
                              'text-anchor': 'middle',
                              transform: 'translate(0, -2)',
                            },
                          },
                        },
                      },
                    ],
                  })),
                  // Left axis
                  (yAxis = leftAxis().config({
                    attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                    ticks: {
                      attributes: {
                        '.tick': { 'font-weight': 'normal' },
                        '.tick[highlighted=true]': { 'font-weight': 'bold' },
                      },
                      scale: bars.categoriesScale(),
                      conditionalConfigs: [
                        {
                          media: 'screen and (min-width: 40rem)',
                          config: { scale: bars.valuesScale() },
                        },
                      ],
                    },
                    title: {
                      text: 'Locations',
                      conditionalConfigs: [
                        { media: 'screen and (min-width: 40rem)', config: { text: 'Revenue' } },
                      ],
                    },
                  })),
                  // Bottom axis
                  (xAxis = bottomAxis().config({
                    attributes: { 'grid-area': '2 / 2 / 3 / 3' },
                    ticks: {
                      attributes: {
                        '.tick': { 'font-weight': 'normal' },
                        '.tick[highlighted=true]': { 'font-weight': 'bold' },
                        '.tick text': {
                          'dominant-baseline': 'hanging',
                          transform: 'translate(0, 7) rotate(-45)',
                          'text-anchor': 'end',
                        },
                      },
                      scale: bars.valuesScale(),
                      conditionalConfigs: [
                        {
                          media: 'screen and (min-width: 40rem)',
                          config: {
                            scale: bars.categoriesScale(),
                            attributes: {
                              '.tick text': {
                                transform: 'translate(0, 7)',
                                'text-anchor': 'middle',
                              },
                            },
                          },
                        },
                      ],
                    },
                    title: {
                      text: 'Revenue',
                      conditionalConfigs: [
                        { media: 'screen and (min-width: 40rem)', config: { text: 'Locations' } },
                      ],
                    },
                  })),
                ],
              }),
              (legend = swatchLegend().config({
                labels: years,
                colors: respVis.GroupedBarsComponent.defaultColors,
                rowCount: 1,
                columnCount: years.length,
                attributes: {
                  'grid-area': '2 / 2 / 3 / 3',
                },
                conditionalConfigs: [
                  {
                    media: 'screen and (min-width: 40rem)',
                    config: {
                      rowCount: years.length,
                      columnCount: 1,
                      attributes: {
                        'grid-area': '2 / 4 / 3 / 5',
                      },
                    },
                  },
                ],
              })),
            ],
          })
        )
        .mount('#chart');
    </script>
  </body>
</html>
