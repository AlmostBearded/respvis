<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>RespVis - Grouped Bar Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <style>
      #chart {
        width: 100%;
        height: 50vh;
        min-height: 25rem;
      }

      body {
        background-color: floralwhite;
      }
    </style>
  </head>
  <body>
    <h1>Grouped Bar Chart</h1>
    <div id="chart"></div>
    <script src="../respvis.js"></script>
    <script type="module">
      import withPaddingLayout from './components/with-padding-layout.js';
      import withLeftAxis from './components/axis/with-left-axis.js';
      import withBottomAxis from './components/axis/with-bottom-axis.js';
      import withHighlightTick from './components/axis/with-highlight-tick.js';
      import withHighlightBar from './components/grouped-bars/with-highlight-bar.js';
      import withShowLabel from './components/bar-labels/with-show-label.js';
      import withSwatchLegend from './components/legend/with-swatch-legend.js';
      import withHighlightLegendSwatch from './components/legend/with-highlight-swatch.js';
      import withDisableLegendSwatch from './components/legend/with-disable-swatch.js';

      // data
      var categories = ['Vienna', 'Rome', 'Paris', 'Berlin', 'Amsterdam'];
      var years = ['2018', '2019', '2020'];
      var values = [
        [23, 27, 29],
        [15, 13, 16],
        [43, 55, 70],
        [30, 24, 28],
        [12, 14, 18],
      ];

      // to toggle subcategories
      var subcategoryToggles = [true, true, true];


      // media query for wide screens
      const wideMediaQuery = 'screen and (min-width: 40rem)';

      // bars
      const barColors = respVis.GroupedBarsComponent.defaultColors;
      const bars = withHighlightBar(respVis.groupedBars()).config({
        categories: categories,
        values: values,
        orientation: respVis.BarOrientation.Horizontal,
        colors: barColors,
        transitionDuration: 1000,
        events: [
          {
            typenames: 'mouseover',
            callback: (e, d) => hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, true),
          },
          {
            typenames: 'mouseout',
            callback: (e, d) => hoverBar(d.categoryIndex, d.barIndex, yAxis, xAxis, false),
          },
        ],
        conditionalConfigs: [
          {
            media: wideMediaQuery,
            config: {
              orientation: respVis.BarOrientation.Vertical,
              // TODO: It might be cleaner to change the events config syntax to...
              // events: {
              //   mouseover: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, true),
              //   mouseout: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, false),
              // },
              events: [
                {
                  typenames: 'mouseover',
                  callback: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, true),
                },
                {
                  typenames: 'mouseout',
                  callback: (e, d) => hoverBar(d.categoryIndex, d.barIndex, xAxis, yAxis, false),
                },
              ],
            },
          },
        ],
      });

      // labels
      const labels = withShowLabel(respVis.barLabels()).config({
        attributes: {
          text: {
            'dominant-baseline': 'middle',
            'text-anchor': 'start',
            transform: 'translate(2, 0)',
            'font-weight': 'bold',
          },
        },
        bars: bars,
        labels: values.flat(),
        horizontalPosition: respVis.HorizontalPosition.Right,
        verticalPosition: respVis.VerticalPosition.Center,
        transitionDuration: 1000,
        conditionalConfigs: [
          {
            media: wideMediaQuery,
            config: {
              horizontalPosition: respVis.HorizontalPosition.Center,
              verticalPosition: respVis.VerticalPosition.Top,
              attributes: {
                text: {
                  'dominant-baseline': 'auto',
                  'text-anchor': 'middle',
                  transform: 'translate(0, -2)',
                },
              },
            },
          },
        ],
      });

      // legend
      const legend = withDisableLegendSwatch(
        withHighlightLegendSwatch(withSwatchLegend(respVis.group()))
      ).config({
        attributes: {
          // TODO: Can't specify grid-area later because conditionalConfigs can't be deep-merged
          'grid-area': '1 / 1 / 2 / 2',
          cursor: 'pointer',
        },
        labels: years,
        colors: barColors,
        rowCount: 1,
        columnCount: years.length,
        events: [
          {
            typenames: 'mouseover',
            callback: (e, d) => hoverLegendSwatch(d.childIndex, true),
          },
          {
            typenames: 'mouseout',
            callback: (e, d) => hoverLegendSwatch(d.childIndex, false),
          },
          {
            typenames: 'click',
            callback: (e, d) => clickLegendSwatch(d.childIndex),
          },
        ],
        conditionalConfigs: [
          {
            media: wideMediaQuery,
            config: {
              rowCount: years.length,
              columnCount: 1,
              attributes: {
                // TODO: Can't specify grid-area later because conditionalConfigs can't be deep-merged
                'grid-area': '1 / 2 / 2 / 3',
              },
            },
          },
        ],
      });

      // bottom axis
      const xAxis = withHighlightTick(withBottomAxis(respVis.group())).config({
        ticks: {
          attributes: { cursor: 'auto' },
          scale: bars.valuesScale(),
          conditionalConfigs: [
            {
              media: wideMediaQuery,
              config: {
                scale: bars.categoriesScale(),
                attributes: { cursor: 'default' },
                events: [
                  {
                    typenames: 'mouseover',
                    callback: (e, d) => hoverCategoryAxisTick(xAxis, yAxis, d.tickIndex, true),
                  },
                  {
                    typenames: 'mouseout',
                    callback: (e, d) => hoverCategoryAxisTick(xAxis, yAxis, d.tickIndex, false),
                  },
                ],
              },
            },
          ],
        },
        title: {
          text: 'Revenue',
          conditionalConfigs: [{ media: wideMediaQuery, config: { text: 'Locations' } }],
        },
      });

      // left axis
      const yAxis = withHighlightTick(withLeftAxis(respVis.group())).config({
        ticks: {
          scale: bars.categoriesScale(),
          attributes: { cursor: 'default' },
          events: [
            {
              typenames: 'mouseover',
              callback: (e, d) => hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, true),
            },
            {
              typenames: 'mouseout',
              callback: (e, d) => hoverCategoryAxisTick(yAxis, xAxis, d.tickIndex, false),
            },
          ],
          conditionalConfigs: [
            {
              media: wideMediaQuery,
              config: {
                scale: bars.valuesScale(),
                attributes: { cursor: 'auto' },
                events: [], // unregister events
              },
            },
          ],
        },
        title: {
          text: 'Locations',
          conditionalConfigs: [{ media: wideMediaQuery, config: { text: 'Revenue' } }],
        },
      });

      const chart = respVis
        .chart()
        .root(
          withPaddingLayout(respVis.group()).config({
            all: 10,
            children: [
              respVis.group().config({
                attributes: { 'grid-template': 'auto 1fr / auto' },
                conditionalConfigs: [
                  {
                    media: wideMediaQuery,
                    config: {
                      attributes: { 'grid-template': '1fr / 1fr auto' },
                    },
                  },
                ],
                children: [
                  withPaddingLayout(respVis.group()).config({
                    top: 5,
                    right: 20,
                    attributes: {
                      'grid-area': '2 / 1 / 3 / 2',
                    },
                    conditionalConfigs: [
                      {
                        media: wideMediaQuery,
                        config: {
                          top: 20,
                          right: 5,
                          attributes: { 'grid-area': '1 / 1 / 2 / 2' },
                        },
                      },
                    ],
                    children: [
                      respVis.group().config({
                        attributes: {
                          'grid-template': '1fr auto / auto 1fr',
                        },
                        children: [
                          // bars
                          bars.config({ attributes: { 'grid-area': '1 / 2 / 2 / 3' } }),

                          // labels
                          labels.config({ attributes: { 'grid-area': '1 / 2 / 2 / 3' } }),

                          // left axis
                          yAxis.config({ attributes: { 'grid-area': '1 / 1 / 2 / 2' } }),

                          // bottom axis
                          xAxis.config({ attributes: { 'grid-area': '2 / 2 / 3 / 3' } }),
                        ],
                      }),
                    ],
                  }),
                  // legend
                  legend,
                ],
              }),
            ],
          })
        )
        .mount('#chart');

      function legendSwatchIndexToBarIndex(swatchIndex) {
        return subcategoryToggles.slice(0, swatchIndex).filter((t) => t).length;
      }

      function barIndexToLegendSwatchIndex(barIndex) {
        let lastIndex = -1;
        for (let i = 0; i <= barIndex; ++i)
          lastIndex = subcategoryToggles.indexOf(true, lastIndex + 1);
        return lastIndex;
      }

      function hoverBar(categoryIndex, barIndex, categoryAxis, valueAxis, hover) {
        const flatBarIndex = categoryIndex * subcategoryToggles.filter((t) => t).length + barIndex;
        bars.highlightBar(categoryIndex, barIndex, hover);
        labels.showLabel(flatBarIndex, hover);
        legend.highlightSwatch(barIndexToLegendSwatchIndex(barIndex), hover);
        valueAxis.clearHighlights();
        categoryAxis.highlightTick(categoryIndex, hover);
        chart.update();
      }

      function hoverCategoryAxisTick(categoryAxis, valueAxis, tickIndex, hover) {
        valueAxis.clearHighlights();
        categoryAxis.highlightTick(tickIndex, hover);
        for (let i = 0; i < subcategoryToggles.filter((t) => t).length; ++i) {
          const flatBarIndex = tickIndex * subcategoryToggles.filter((t) => t).length + i;
          bars.highlightBar(tickIndex, i, hover);
          labels.showLabel(flatBarIndex, hover);
        }

        chart.update();
      }

      function hoverLegendSwatch(swatchIndex, hover) {
        if (subcategoryToggles[swatchIndex] === false) return;

        categories.forEach((category, categoryIndex) => {
          let barIndex = legendSwatchIndexToBarIndex(swatchIndex);
          const flatBarIndex =
            categoryIndex * subcategoryToggles.filter((t) => t).length + barIndex;
          bars.highlightBar(categoryIndex, barIndex, hover);
          labels.showLabel(flatBarIndex, hover);
        });
        legend.highlightSwatch(swatchIndex, hover);
        chart.update();
      }

      function clickLegendSwatch(swatchIndex) {
        // Prevent hiding the last subcategory
        if (
          subcategoryToggles.filter((t) => t).length === 1 &&
          subcategoryToggles[swatchIndex] === true
        )
          return;

        hoverLegendSwatch(swatchIndex, false);

        subcategoryToggles[swatchIndex] = !subcategoryToggles[swatchIndex];
        const newValues = values.map((subcategoryValues) =>
          subcategoryValues.filter((c, i) => subcategoryToggles[i])
        );
        bars.config({
          values: newValues,
          colors: barColors.filter((c, i) => subcategoryToggles[i]),
        });

        labels.config({ labels: newValues.flat() });

        legend.disableSwatch(swatchIndex, !subcategoryToggles[swatchIndex]);

        chart.update();
      }
    </script>
  </body>
</html>
